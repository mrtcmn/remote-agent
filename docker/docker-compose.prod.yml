# Remote Agent Production Docker Compose
# Uses pre-built image from ghcr.io with host-mounted volumes
# For development, use docker-compose.yml or docker-compose.dev.yml instead

services:
  db:
    image: postgres:16-alpine
    container_name: remote-agent-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-agent}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=${POSTGRES_DB:-remote_agent}
    volumes:
      - postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agent} -d ${POSTGRES_DB:-remote_agent}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  remote-agent:
    image: ghcr.io/yourorg/remote-agent:${IMAGE_TAG:-latest}
    container_name: remote-agent
    ports:
      - "${PORT:-5100}:5100"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      # User data - host mounted for easy backup and visibility
      - ${INSTALL_DIR:-/opt/remote-agent}/workspaces:/app/workspaces
      - ${INSTALL_DIR:-/opt/remote-agent}/ssh-keys:/app/ssh-keys
      # Custom config (read-only)
      - ${INSTALL_DIR:-/opt/remote-agent}/config:/app/config:ro
    environment:
      # Database
      - DATABASE_URL=postgres://${POSTGRES_USER:-agent}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-remote_agent}

      # Required
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY is required}

      # GitHub OAuth
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:?GITHUB_CLIENT_ID is required}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:?GITHUB_CLIENT_SECRET is required}

      # Firebase Push Notifications (optional)
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY:-}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL:-}

      # Security
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}

      # App
      - APP_URL=${APP_URL:-http://localhost:5100}
      - APP_VERSION=${IMAGE_TAG:-latest}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - NODE_ENV=production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  postgres:
    name: remote-agent-postgres
