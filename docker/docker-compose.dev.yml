# Development docker-compose with hot-reloading and debugging

services:
  db:
    image: postgres:16-alpine
    container_name: remote-agent-db-dev
    ports:
      - "127.0.0.1:${DB_PORT:-5432}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-agent}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-agent}
      - POSTGRES_DB=${POSTGRES_DB:-remote_agent}
    volumes:
      - dev-postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agent} -d ${POSTGRES_DB:-remote_agent}"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: remote-agent-dev
    ports:
      - "127.0.0.1:${PORT:-5100}:5100"
      - "127.0.0.1:${DEBUG_PORT:-6499}:6499"  # Bun inspector port
    depends_on:
      db:
        condition: service_healthy
    volumes:
      # Mount source code for hot-reloading
      - ../packages:/app/packages:cached
      - ../package.json:/app/package.json:ro
      - ../tsconfig.json:/app/tsconfig.json:ro

      # Preserve node_modules from image (don't override with host mount)
      - /app/node_modules
      - /app/packages/api/node_modules
      - /app/packages/ui/node_modules

      # Persistent data (survives container restarts)
      - dev-workspaces:/app/workspaces

      # SSH keys
      - dev-ssh-keys:/app/ssh-keys
    environment:
      # Database
      - DATABASE_URL=postgres://${POSTGRES_USER:-agent}:${POSTGRES_PASSWORD:-agent}@db:5432/${POSTGRES_DB:-remote_agent}

      # Required
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Auth
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}

      # Firebase (optional)
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY:-}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL:-}

      # Development settings
      - NODE_ENV=development
      - APP_URL=http://localhost:${PORT:-5100}
      - CORS_ORIGIN=*
      - PORT=5100

      # Debug settings
      - BUN_DEBUG_QUIET_LOGS=0
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5100/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  dev-postgres:
    name: remote-agent-dev-postgres
  dev-workspaces:
    name: remote-agent-dev-workspaces
  dev-ssh-keys:
    name: remote-agent-dev-ssh-keys
