services:
  db:
    image: postgres:16-alpine
    container_name: remote-agent-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-agent}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=${POSTGRES_DB:-remote_agent}
    volumes:
      - postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agent} -d ${POSTGRES_DB:-remote_agent}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  remote-agent:
    # Use pre-built image if IMAGE_TAG is set, otherwise build locally
    image: ${IMAGE_TAG:+ghcr.io/yourorg/remote-agent:}${IMAGE_TAG:-}
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        - VERSION=${IMAGE_TAG:-dev}
    container_name: remote-agent
    ports:
      - "127.0.0.1:${PORT:-5100}:5100"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      # Persistent data
      - workspaces:/app/workspaces
      - ssh-keys:/app/ssh-keys
      # Custom config (read-only)
      - ./config:/app/config:ro
    environment:
      # Database
      - DATABASE_URL=postgres://${POSTGRES_USER:-agent}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-remote_agent}

      # Required
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # GitHub OAuth
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}

      # Firebase Push Notifications
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY:-}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL:-}

      # Firebase Client Config (injected into frontend at runtime)
      - VITE_FIREBASE_API_KEY=${VITE_FIREBASE_API_KEY:-}
      - VITE_FIREBASE_AUTH_DOMAIN=${VITE_FIREBASE_AUTH_DOMAIN:-}
      - VITE_FIREBASE_PROJECT_ID=${VITE_FIREBASE_PROJECT_ID:-}
      - VITE_FIREBASE_STORAGE_BUCKET=${VITE_FIREBASE_STORAGE_BUCKET:-}
      - VITE_FIREBASE_MESSAGING_SENDER_ID=${VITE_FIREBASE_MESSAGING_SENDER_ID:-}
      - VITE_FIREBASE_APP_ID=${VITE_FIREBASE_APP_ID:-}
      - VITE_FIREBASE_MEASUREMENT_ID=${VITE_FIREBASE_MEASUREMENT_ID:-}
      - VITE_FIREBASE_VAPID_KEY=${VITE_FIREBASE_VAPID_KEY:-}

      # Security
      - JWT_SECRET=${JWT_SECRET}

      # App
      - APP_URL=${APP_URL:-http://localhost:5100}
      - APP_VERSION=${IMAGE_TAG:-dev}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - NODE_ENV=${NODE_ENV:-production}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  postgres:
    name: remote-agent-postgres
  workspaces:
    name: remote-agent-workspaces
  ssh-keys:
    name: remote-agent-ssh-keys
